<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ë””ì˜¤ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 600px;
            width: 100%;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1.5rem; /* Rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: #3b82f6; /* Blue-500 */
            border-radius: 9999px; /* Full rounded */
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
<div class="container space-y-6">
    <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8">ë¹„ë””ì˜¤ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</h1>

    <div class="mb-6">
        <label for="fileInput" class="block text-gray-700 text-lg font-semibold mb-2">
            íŒŒì¼ ì„ íƒ:
        </label>
        <input type="file" id="fileInput" accept="video/*" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out">
    </div>

    <div class="space-y-4">
        <button id="uploadButton"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
            ì—…ë¡œë“œ ì‹œì‘
        </button>
        <button id="abortButton"
                class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300 hidden">
            ì—…ë¡œë“œ ì¤‘ë‹¨
        </button>
    </div>

    <div id="progressContainer" class="mt-8 bg-gray-200 rounded-full h-8 overflow-hidden shadow-inner hidden">
        <div class="progress-bar h-full text-center text-white text-sm font-semibold flex items-center justify-center" id="progressBar">0%</div>
    </div>

    <div id="statusMessage" class="mt-4 p-4 rounded-xl text-center text-gray-700 bg-blue-50 border border-blue-200 hidden">
        ì—…ë¡œë“œ ìƒíƒœê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
    </div>

    <div id="resultContainer" class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-sm hidden">
        <h3 class="text-xl font-bold text-gray-800 mb-3">ì—…ë¡œë“œ ê²°ê³¼:</h3>
        <p class="text-gray-700 break-words">
            <span class="font-semibold">íŒŒì¼ í‚¤:</span> <span id="resultFileKey" class="text-blue-700"></span><br>
            <span class="font-semibold">ìµœì¢… URL:</span> <span id="resultUrl" class="text-green-700"></span>
        </p>
        <button id="copyUrlButton" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-300">
            URL ë³µì‚¬
        </button>
    </div>

    <div id="messageBox" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full text-center space-y-4">
            <p id="messageBoxContent" class="text-lg font-semibold text-gray-800"></p>
            <button id="messageBoxClose" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-300">
                í™•ì¸
            </button>
        </div>
    </div>
</div>
<script>
    // ì¤‘ìš”: ì´ URLì„ ì‹¤ì œ ë°±ì—”ë“œ APIì˜ ê¸°ë³¸ URLë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.
    // ì˜ˆë¥¼ ë“¤ì–´, "http://localhost:8080" ë˜ëŠ” "https://your-api-domain.com"
    const API_BASE_URL = 'http://localhost:8080'; // <-- ì—¬ê¸°ì— ì‹¤ì œ ë°±ì—”ë“œ URLì„ ì…ë ¥í•˜ì„¸ìš”!
    const PART_SIZE = 6 * 1024 * 1024; // 6MB (ë°±ì—”ë“œ PART_SIZEì™€ ì¼ì¹˜)

    let selectedFile = null;
    let uploadId = null;
    let fileKey = null;
    let etags = [];
    let completedParts = 0;
    let totalParts = 0;
    let isAborting = false;

    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');
    const abortButton = document.getElementById('abortButton');
    const statusMessage = document.getElementById('statusMessage');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const resultContainer = document.getElementById('resultContainer');
    const resultFileKey = document.getElementById('resultFileKey');
    const resultUrl = document.getElementById('resultUrl');
    const copyUrlButton = document.getElementById('copyUrlButton');
    const messageBox = document.getElementById('messageBox');
    const messageBoxContent = document.getElementById('messageBoxContent');
    const messageBoxClose = document.getElementById('messageBoxClose');

    // ë©”ì‹œì§€ ë°•ìŠ¤ í‘œì‹œ í•¨ìˆ˜
    function showMessageBox(message) {
        messageBoxContent.textContent = message;
        messageBox.classList.remove('hidden');
    }

    // ë©”ì‹œì§€ ë°•ìŠ¤ ë‹«ê¸° í•¨ìˆ˜
    function closeMessageBox() {
        messageBox.classList.add('hidden');
    }

    messageBoxClose.addEventListener('click', closeMessageBox);

    fileInput.addEventListener('change', (event) => {
        selectedFile = event.target.files[0];
        if (selectedFile) {
            statusMessage.textContent = `íŒŒì¼ ì„ íƒë¨: ${selectedFile.name} (${(selectedFile.size / (1024 * 1024)).toFixed(2)} MB)`;
            statusMessage.classList.remove('hidden');
            uploadButton.disabled = false;
            resetUploadState();
        } else {
            statusMessage.textContent = 'íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            statusMessage.classList.remove('hidden');
            uploadButton.disabled = true;
        }
    });

    uploadButton.addEventListener('click', startUpload);
    abortButton.addEventListener('click', abortUpload);
    copyUrlButton.addEventListener('click', copyUrlToClipboard);

    function resetUploadState() {
        uploadId = null;
        fileKey = null;
        etags = [];
        completedParts = 0;
        totalParts = 0;
        isAborting = false;
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressContainer.classList.add('hidden');
        resultContainer.classList.add('hidden');
        abortButton.classList.add('hidden');
        statusMessage.classList.remove('bg-red-100', 'border-red-300', 'text-red-800');
        statusMessage.classList.remove('bg-green-100', 'border-green-300', 'text-green-800');
        statusMessage.classList.add('bg-blue-50', 'border-blue-200', 'text-gray-700');
    }

    async function startUpload() {
        if (!selectedFile) {
            showMessageBox('ë¨¼ì € ë™ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        uploadButton.disabled = true;
        abortButton.classList.remove('hidden');
        progressContainer.classList.remove('hidden');
        setStatus('ì—…ë¡œë“œ ì´ˆê¸°í™” ì¤‘...', 'blue');

        try {
            // 1. ë©€í‹°íŒŒíŠ¸ ì—…ë¡œë“œ ì´ˆê¸°í™” ìš”ì²­
            const initResponse = await fetch(`${API_BASE_URL}/api/attachments/videos/init`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fileName: selectedFile.name,
                    contentType: selectedFile.type,
                    fileSize: selectedFile.size
                })
            });

            if (!initResponse.ok) {
                const errorData = await initResponse.json();
                throw new Error(`ì—…ë¡œë“œ ì´ˆê¸°í™” ì‹¤íŒ¨: ${errorData.message || initResponse.statusText}`);
            }

            const data = await initResponse.json();
            const { uploadId: receivedUploadId, fileKey: receivedFileKey, presignedUrls, partCount } = data.data;

            uploadId = receivedUploadId;
            fileKey = receivedFileKey;
            totalParts = partCount;
            etags = [];
            completedParts = 0;

            setStatus(`ì—…ë¡œë“œ ì‹œì‘: ì´ ${totalParts} íŒŒíŠ¸`, 'blue');

            // 2. ê° íŒŒíŠ¸ ì—…ë¡œë“œ
            for (let i = 0; i < presignedUrls.length; i++) {
                if (isAborting) {
                    setStatus('ì—…ë¡œë“œ ì¤‘ë‹¨ë¨.', 'red');
                    return;
                }

                const partNumber = i + 1;
                const start = i * PART_SIZE;
                const end = Math.min(start + PART_SIZE, selectedFile.size);
                const chunk = selectedFile.slice(start, end);

                setStatus(`íŒŒíŠ¸ ${partNumber}/${totalParts} ì—…ë¡œë“œ ì¤‘...`, 'blue');

                const uploadPartResponse = await fetch(presignedUrls[i], {
                    method: 'PUT',
                    body: chunk,
                    headers: {
                        'Content-Type': selectedFile.type // ê° íŒŒíŠ¸ì˜ Content-Typeë„ ì¤‘ìš”
                    }
                });

                if (!uploadPartResponse.ok) {
                    throw new Error(`íŒŒíŠ¸ ${partNumber} ì—…ë¡œë“œ ì‹¤íŒ¨: ${uploadPartResponse.statusText}`);
                }

                const etag = uploadPartResponse.headers.get('ETag');
                etags.push({ partNumber: partNumber, eTag: etag.replace(/"/g, '') }); // ETagì—ì„œ í°ë”°ì˜´í‘œ ì œê±°

                completedParts++;
                updateProgress();
            }

            // 3. ë©€í‹°íŒŒíŠ¸ ì—…ë¡œë“œ ì™„ë£Œ ìš”ì²­
            setStatus('ì—…ë¡œë“œ ì™„ë£Œ ìš”ì²­ ì¤‘...', 'blue');
            const completeResponse = await fetch(`${API_BASE_URL}/api/attachments/videos/complete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    uploadId: uploadId,
                    fileKey: fileKey, // fileKeyë„ í•¨ê»˜ ë³´ëƒ„
                    completedParts: etags
                })
            });

            if (!completeResponse.ok) {
                const errorData = await completeResponse.json();
                throw new Error(`ì—…ë¡œë“œ ì™„ë£Œ ì‹¤íŒ¨: ${errorData.message || completeResponse.statusText}`);
            }

            // ì‘ë‹µ ê°ì²´ êµ¬ì¡°ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. data.videoUrlì—ì„œ ìµœì¢… URLì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
            const completeData = await completeResponse.json();
            const finalS3Url = completeData.data.videoUrl; // <-- ì´ ë¶€ë¶„ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

            setStatus('ì—…ë¡œë“œ ì™„ë£Œ! ğŸ‰', 'green');
            showResult(fileKey, finalS3Url);

        } catch (error) {
            setStatus(`ì—…ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'red');
            showMessageBox(`ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
            console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            if (uploadId && !isAborting) {
                // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì—…ë¡œë“œ ì¤‘ë‹¨ ë¡œì§ í˜¸ì¶œ (ì„ íƒ ì‚¬í•­, í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ í•„ìš”í•  ê²½ìš°)
                // await abortUploadOnFailure(fileKey, uploadId);
            }
        } finally {
            uploadButton.disabled = false;
            abortButton.classList.add('hidden');
        }
    }

    async function abortUpload() {
        if (!uploadId || !fileKey) {
            showMessageBox('ì¤‘ë‹¨í•  ì—…ë¡œë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        isAborting = true; // ì—…ë¡œë“œ ë£¨í”„ ì¤‘ë‹¨ í”Œë˜ê·¸ ì„¤ì •
        setStatus('ì—…ë¡œë“œ ì¤‘ë‹¨ ìš”ì²­ ì¤‘...', 'red');
        uploadButton.disabled = true;
        abortButton.disabled = true;

        try {
            const abortRequest = await fetch(`${API_BASE_URL}/api/attachments/videos/abort`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fileKey: fileKey,
                    uploadId: uploadId
                })
            });

            if (!abortRequest.ok) {
                const errorData = await abortRequest.json();
                throw new Error(`ì—…ë¡œë“œ ì¤‘ë‹¨ ì‹¤íŒ¨: ${errorData.message || abortRequest.statusText}`);
            }

            setStatus('ì—…ë¡œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'red');
            resetUploadState(); // ìƒíƒœ ì´ˆê¸°í™”
        } catch (error) {
            setStatus(`ì—…ë¡œë“œ ì¤‘ë‹¨ ì˜¤ë¥˜: ${error.message}`, 'red');
            showMessageBox(`ì—…ë¡œë“œ ì¤‘ë‹¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
            console.error('ì—…ë¡œë“œ ì¤‘ë‹¨ ì‹¤íŒ¨:', error);
        } finally {
            uploadButton.disabled = false;
            abortButton.disabled = false;
            abortButton.classList.add('hidden');
        }
    }

    function updateProgress() {
        const percentage = totalParts > 0 ? (completedParts / totalParts) * 100 : 0;
        progressBar.style.width = `${percentage.toFixed(0)}%`;
        progressBar.textContent = `${percentage.toFixed(0)}%`;
    }

    function setStatus(message, type = 'blue') {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden', 'bg-blue-50', 'border-blue-200', 'bg-red-100', 'border-red-300', 'text-red-800', 'bg-green-100', 'border-green-300', 'text-green-800');
        if (type === 'blue') {
            statusMessage.classList.add('bg-blue-50', 'border-blue-200', 'text-gray-700');
        } else if (type === 'red') {
            statusMessage.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
        } else if (type === 'green') {
            statusMessage.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
        }
    }

    function showResult(fileKey, url) {
        resultContainer.classList.remove('hidden');
        resultFileKey.textContent = fileKey;
        resultUrl.textContent = url;
    }

    function copyUrlToClipboard() {
        const url = resultUrl.textContent;
        if (url) {
            const tempInput = document.createElement('textarea');
            tempInput.value = url;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showMessageBox('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (err) {
                showMessageBox('URL ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì €ê°€ ì§€ì›í•˜ì§€ ì•Šê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
            }
            document.body.removeChild(tempInput);
        }
    }

    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    uploadButton.disabled = true; // íŒŒì¼ ì„ íƒ ì „ì—ëŠ” ë¹„í™œì„±í™”
    setStatus('ì—…ë¡œë“œë¥¼ ì‹œì‘í•˜ë ¤ë©´ ë™ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.', 'blue');
</script>
</body>
</html>